<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Creating Maps | R Without Statistics</title>
<meta name="author" content="David Keyes">
<meta name="description" content="When I first started learning R, I considered it a tool for working with numbers, not shapes, so I was surprised when I saw people using it to make maps. Abdoul Madjid, a developer, has been...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="Chapter 5 Creating Maps | R Without Statistics">
<meta property="og:type" content="book">
<meta property="og:url" content="https://book.rwithoutstatistics.com/creating-maps.html">
<meta property="og:image" content="https://book.rwithoutstatistics.com/mock-cover.png">
<meta property="og:description" content="When I first started learning R, I considered it a tool for working with numbers, not shapes, so I was surprised when I saw people using it to make maps. Abdoul Madjid, a developer, has been...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Creating Maps | R Without Statistics">
<meta name="twitter:description" content="When I first started learning R, I considered it a tool for working with numbers, not shapes, so I was surprised when I saw people using it to make maps. Abdoul Madjid, a developer, has been...">
<meta name="twitter:image" content="https://book.rwithoutstatistics.com/mock-cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Without Statistics</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled"><li><a class="" href="index.html"><span class="header-section-number">Chapter 5</span> Creating Maps</a></li></ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rfortherestofus/r-without-statistics">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="creating-maps" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Creating Maps<a class="anchor" aria-label="anchor" href="#creating-maps"><i class="fas fa-link"></i></a>
</h1>
<p>When I first started learning R, I considered it a tool for working with numbers, not shapes, so I was surprised when I saw people using it to make maps. Abdoul Madjid, a developer, has been creating maps with R for several years. Recently, he used one to visualize rates of COVID-19 in the United States in 2021.
You might think you need specialized mapmaking software like ArcGIS to make maps, but this tool is expensive, and while Excel has added support for map-making in recent years, its features are limited (for example, you can’t use it to make maps based on street addresses). Even QGIS, an open source tool similar to ArcGIS, still requires learning new skills.</p>
<p>Using R for map-making has benefits. It lets you perform all of your data manipulation tasks with one tool and apply the principles of high-quality data visualization discussed in Chapter <a href="data-viz-chapter.html#data-viz-chapter">3</a>. For example, Madjid used R to obtain his data, analyze it, and make his COVID-19 map, which you can see in Figure <a href="creating-maps.html#fig:madjid-covid-map">5.1</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:madjid-covid-map"></span>
<img src="assets/covid-map.png" alt="Abdoul Madjid's map of COVID in the United States in 2021" width="100%"><p class="caption">
Figure 5.1: Abdoul Madjid’s map of COVID in the United States in 2021
</p>
</div>
<p>In this chapter, we’ll explore principles of working with geospatial data, then walk through Madjid’s code to understand how he created this high-quality map. We’ll also discuss where to find geospatial data and how to use it to make your own maps.</p>
<div id="the-briefest-of-primers-on-geospatial-data" class="section level2 unnumbered">
<h2>The Briefest of Primers on Geospatial Data<a class="anchor" aria-label="anchor" href="#the-briefest-of-primers-on-geospatial-data"><i class="fas fa-link"></i></a>
</h2>
<p>You don’t need to be a GIS expert to make maps. But you do need to understand a few things about how geospatial data works, starting with its two main types: vector and raster. <em>Vector</em> data uses points, lines, and polygons to represent the world. <em>Raster</em> data, which often comes from digital photographs, ties each pixel in an image to a specific geographic location. Vector data tends to be easier to work with, and we’ll be using it exclusively in this chapter.</p>
<p>In the past, working with geospatial data meant mastering competing standards, each of which required learning a different approach. Today, though, most people use the <em>simple features</em> model for working with vector geospatial data (often abbreviated as <em>sf</em>), which is way easier to understand. For example, take a look at some simple features geospatial data that represents the US state of Wyoming:</p>
<pre><code>#&gt; Simple feature collection with 1 feature and 1 field
#&gt; Geometry type: POLYGON
#&gt; Dimension:     XY
#&gt; Bounding box:  xmin: -111.0546 ymin: 40.99477 xmax: -104.0522 ymax: 45.00582
#&gt; Geodetic CRS:  WGS 84
#&gt;      NAME                       geometry
#&gt; 1 Wyoming POLYGON ((-111.0449 43.3157...</code></pre>
<p>You can see that the data has two columns, one for the state name (NAME) and another called geometry. This data looks like the data frames you’re used to encountering, aside from two major differences: There’s a bunch of metadata above the data frame, and our simple features data contains geographical data in avariable called <code>geometry.</code> The metadata begins with the text “Simple feature collection with 1 feature and 1 field” (because the <code>geometry</code> column must be present in order for a data frame to be geospatial data it is not counted as a field). The feature referenced here is the row, and the field is the <code>NAME</code> variable, which contains non-spatial data (the <code>geometry</code> column will be discussed below). This line, and the lines that follow, are metadata about the geospatial data in the <code>wyoming</code> object. Let’s look at each part of this simple features data.</p>
<div id="geometry-type" class="section level3 unnumbered">
<h3>Geometry Type<a class="anchor" aria-label="anchor" href="#geometry-type"><i class="fas fa-link"></i></a>
</h3>
<p>The geometry type represents the shape of the geospatial data we’re working with. These types are typically written in all caps. In this case, the relatively simple <code>POLYGON</code> type represents a single polygon. We can use ggplot to display this data by calling <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code>, a special geom designed to work with simple features data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wyoming</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Figure <a href="creating-maps.html#fig:wyoming-map-plot">5.2</a> shows the resulting map of Wyoming. It may not look like much, but, hey, I wasn’t the one who chose to make Wyoming a nearly perfect rectangle!</p>
<div class="figure">
<span style="display:block;" id="fig:wyoming-map-plot"></span>
<img src="maps_files/figure-html/wyoming-map-plot-1.png" alt="A map of Wyoming" width="100%"><p class="caption">
Figure 5.2: A map of Wyoming
</p>
</div>
<p><code>POLYGON</code> is one of several geometry types that sf data can be used to represent. Others include:</p>
<p>Other geometry types used in simple feature data include <code>POINT</code>, to display elements such as a pin on a map that represents a single location. Figure <a href="creating-maps.html#fig:ev-stations-map">5.3</a> is a map showing the location of a single electric vehicle charging station in Wyoming.</p>
<div class="figure">
<span style="display:block;" id="fig:ev-stations-map"></span>
<img src="maps_files/figure-html/ev-stations-map-1.png" alt="A map of a single electric vehicle charging station in Wyoming" width="100%"><p class="caption">
Figure 5.3: A map of a single electric vehicle charging station in Wyoming
</p>
</div>
<p>The <code>LINESTRING</code> geometry type is for set of points that can be connected with lines, often used to represent roads. The <code>LINESTRING</code> in Figure <a href="creating-maps.html#fig:wy-roads-map">5.4</a> shows a section of US Highway 30 that runs through Wyoming.</p>
<div class="figure">
<span style="display:block;" id="fig:wy-roads-map"></span>
<img src="maps_files/figure-html/wy-roads-map-1.png" alt="A map of a section of U.S. Highway 30 running through Wyoming" width="100%"><p class="caption">
Figure 5.4: A map of a section of U.S. Highway 30 running through Wyoming
</p>
</div>
<p>Each of these geometry types has a <code>MULTI</code> variation (<code>MULTIPOINT</code>, <code>MULTILINESTRING</code>, and <code>MULTIPOLYGON</code>) that combines multiple instances of the type in one row of data. For example, the data used to make Figure <a href="creating-maps.html#fig:wyoming-ev-stations-map">5.5</a>, which shows all electric vehicle charging stations in Wyoming, is <code>MULTIPOINT</code>.</p>
<div class="figure">
<span style="display:block;" id="fig:wyoming-ev-stations-map"></span>
<img src="maps_files/figure-html/wyoming-ev-stations-map-1.png" alt="A map of all electric vehicle charging stations in Wyoming" width="100%"><p class="caption">
Figure 5.5: A map of all electric vehicle charging stations in Wyoming
</p>
</div>
<p>Likewise, we can use MULTILINESTRING data to show not just one road, but all major roads in Wyoming, as in Figure <a href="creating-maps.html#fig:wyoming-roads-map">5.6</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:wyoming-roads-map"></span>
<img src="maps_files/figure-html/wyoming-roads-map-1.png" alt="A map of all major roads in Wyoming" width="100%"><p class="caption">
Figure 5.6: A map of all major roads in Wyoming
</p>
</div>
<p>Lastly, we could use MULTIPOLYGON data to, for example, depict a state made up of multiple polygons. To see what I mean, take a look at a map of Wyoming’s counties. The following simple features data represents the 23 counties in the state:</p>
<pre><code>#&gt; Simple feature collection with 23 features and 1 field
#&gt; Geometry type: MULTIPOLYGON
#&gt; Dimension:     XY
#&gt; Bounding box:  xmin: -111.0546 ymin: 40.99477 xmax: -104.0522 ymax: 45.00582
#&gt; Geodetic CRS:  WGS 84
#&gt; First 10 features:
#&gt;             NAME                       geometry
#&gt; 34       Lincoln MULTIPOLYGON (((-111.0472 4...
#&gt; 104      Fremont MULTIPOLYGON (((-109.4582 4...
#&gt; 121        Uinta MULTIPOLYGON (((-110.6068 4...
#&gt; 527     Big Horn MULTIPOLYGON (((-108.5923 4...
#&gt; 551  Hot Springs MULTIPOLYGON (((-109.1714 4...
#&gt; 601     Washakie MULTIPOLYGON (((-107.6335 4...
#&gt; 769     Converse MULTIPOLYGON (((-105.6985 4...
#&gt; 970   Sweetwater MULTIPOLYGON (((-110.0489 4...
#&gt; 977        Crook MULTIPOLYGON (((-105.0856 4...
#&gt; 1097      Carbon MULTIPOLYGON (((-106.9129 4...</code></pre>
<p>We can see that the geometry type of this data is <code>MULTIPOLYGON</code>. In addition, the repeated <code>MULTIPOLYGON</code> text in the geometry column indicates that each row contains a shape of type <code>MULTIPOLYGON</code>. Figure <a href="creating-maps.html#fig:wyoming-counties-map">5.7</a> is a map made with this data.</p>
<div class="figure">
<span style="display:block;" id="fig:wyoming-counties-map"></span>
<img src="maps_files/figure-html/wyoming-counties-map-1.png" alt="A map of Wyoming counties" width="100%"><p class="caption">
Figure 5.7: A map of Wyoming counties
</p>
</div>
<p>You can easily see the multiple polygons that make up the map.</p>
</div>
<div id="the-dimensions" class="section level3 unnumbered">
<h3>The Dimensions<a class="anchor" aria-label="anchor" href="#the-dimensions"><i class="fas fa-link"></i></a>
</h3>
<p>Next, the geospatial data frame contains the data’s <em>dimensions</em>, or the type of geospatial data we’re working with. In the Wyoming example, it looks like this: <code>Dimension: XY</code>, meaning the data is two-dimensional, as in the case of all the geospatial data used in this chapter. There are two other dimensions (<code>Z</code> and <code>M</code>) that you’ll see much more rarely. I’ll leave them for you to investigate further.</p>
</div>
<div id="bounding-box" class="section level3 unnumbered">
<h3>Bounding Box<a class="anchor" aria-label="anchor" href="#bounding-box"><i class="fas fa-link"></i></a>
</h3>
<p>The penultimate element in the metadata is the bounding box. A <em>bounding box</em> represents the smallest area in which we can fit all of our geospatial data. For our <code>wyoming</code> object, it looks like this:</p>
<p><code>Bounding box:  xmin: -111.0569 ymin: 40.99475 xmax: -104.0522 ymax: 45.0059</code></p>
<p>The <code>ymin</code> value of 40.99475 and <code>ymax</code> value of 45.0059 represent the lowest and highest latitude, respectively, that the state’s polygon can fit into. The x values do the same for the longitude. Bounding boxes are calculated automatically, and you don’t typically have to worry about altering them.</p>
</div>
<div id="the-geodetic-crs" class="section level3 unnumbered">
<h3>The Geodetic CRS<a class="anchor" aria-label="anchor" href="#the-geodetic-crs"><i class="fas fa-link"></i></a>
</h3>
<p>The last piece of metadata specifies the <em>coordinate reference system</em> used to project our data when we plot it. The problem with representing any geospatial data is that we’re displaying information about the three-dimensional Earth on a two-dimensional map. Doing so requires us to choose a coordinate reference system that determines what type of correspondence, or <em>projection</em>, to use when making our map.</p>
<p>The data for the Wyoming counties map includes the line <code>Geodetic CRS: WGS 84</code>, indicating the use of a coordinate reference system known as <em>WGS84</em>. To see a different projection, check out the same map using what’s known as the <em>Albers equal-area conic convenience projection</em>. While Wyoming looked perfectly horizontal in Figure <a href="creating-maps.html#fig:wyoming-counties-map">5.7</a>, the version in Figure <a href="creating-maps.html#fig:wyoming-counties-map-wgs84">5.8</a> appears to be tilted.</p>
<div class="figure">
<span style="display:block;" id="fig:wyoming-counties-map-wgs84"></span>
<img src="maps_files/figure-html/wyoming-counties-map-wgs84-1.png" alt="A map of Wyoming counties using the WGS84 projection" width="100%"><p class="caption">
Figure 5.8: A map of Wyoming counties using the WGS84 projection
</p>
</div>
<p>To see how different a map that uses a different projection can look, check out another map of Wyoming counties, this time using what’s known as the “Albers equal-area conic convenience projection.” Whereas Wyoming looked perfectly horizontal in Figure <a href="creating-maps.html#fig:wyoming-counties-map-wgs84">5.8</a> above, in Figure <a href="creating-maps.html#fig:wyoming-counties-map-5070">5.9</a> below it appears to be tilted.</p>
<div class="figure">
<span style="display:block;" id="fig:wyoming-counties-map-5070"></span>
<img src="maps_files/figure-html/wyoming-counties-map-5070-1.png" alt="A map of Wyoming counties using the Albers equal-area conic convenience projection" width="100%"><p class="caption">
Figure 5.9: A map of Wyoming counties using the Albers equal-area conic convenience projection
</p>
</div>
<p>If you’re curious about how to change projections when making maps of your own, fear not. You’ll see how to do this when we look at Abdoul Madjid’s map. And if you want to know how to choose appropriate projections for your maps, check out the conclusion of the chapter.</p>
</div>
<div id="the-geometry-column" class="section level3 unnumbered">
<h3>The <code>geometry</code> Column<a class="anchor" aria-label="anchor" href="#the-geometry-column"><i class="fas fa-link"></i></a>
</h3>
<p>In addition to the metadata, our simple features data differs from traditional data frames in another respect: its <code>geometry</code> column. As you probably guessed from the name, it holds the data needed to make our maps.</p>
<p>To understand how this works, consider the connect-the-dots drawings you probably completed as a kid. As you added lines to connect one point to the next, the subject of your drawing became clear. The geometry column is similar. It has a set of numbers, each of which corresponds to a point. If you’re using <code>LINESTRING/MULTILINESTRING</code> or <code>POLYGON/MULTIPOLYGON</code> simple features data, ggplot uses the numbers in the geometry column to draw each point and then adds lines to connect the points. If you’re using <code>POINT/MULTIPOINT</code> data, it draws the points but doesn’t connect them.</p>
<p>Once again, you never have to worry about these details or look in any depth at the <code>geometry</code> column.</p>
</div>
</div>
<div id="recreating-the-covid-map" class="section level2 unnumbered">
<h2>Recreating the COVID Map<a class="anchor" aria-label="anchor" href="#recreating-the-covid-map"><i class="fas fa-link"></i></a>
</h2>
<p>Now that you understand the basics of geospatial data, let’s walk through the code Madjid used to make his COVID-19 map., which makes use of the geometry types, dimensions, bounding boxes, projections, and the <code>geometry</code> column we just explored. (I’ve made some small modifications to the code to make the final map fit on the page.) Let’s begin by loading few packages:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hrbrmstr/albersusa">albersusa</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://zoo.R-Forge.R-project.org/">zoo</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://colorspace.R-Forge.R-project.org/">colorspace</a></span><span class="op">)</span></span></code></pre></div>
<p>We’ll use <code>tidyverse</code> to import data, manipulate it, and plot it (with ggplot). The <code>albersusa</code> package will give us access to geospatial data, and the <code>sf</code> package will enable us to change its coordinate reference system to use an appropriate projection. The <code>zoo</code> package has functions for calculating rolling averages, and the <code>colorspace</code> package gives us a color scale that highlights the data well.</p>
<div id="importing-the-data" class="section level3 unnumbered">
<h3>Importing the Data<a class="anchor" aria-label="anchor" href="#importing-the-data"><i class="fas fa-link"></i></a>
</h3>
<p>Next, let’s import the data we need. We require three pieces of data: COVID rates by state over time, state populations, and geospatial information. Madjid imported each of these pieces of data separately and then merged them, and we’ll do the same.</p>
<p>First, we import COVID data. This data comes directly from <em>The New York Times</em>, which publishes daily case rates by state as a CSV file on its GitHub account. I’ve dropped the <code>fips</code> variable; Federal Information Processing Standards (FIPS) are numeric codes used to represent states, but we can reference states by their names instead:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covid_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">fips</span><span class="op">)</span></span></code></pre></div>
<p>If you take a look at this data, you can see the arrival of the first COVID cases in the United States in January 2020.</p>
<pre><code>#&gt; # A tibble: 57,518 × 4
#&gt;    date       state      cases deaths
#&gt;    &lt;date&gt;     &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;
#&gt;  1 2020-01-21 Washington     1      0
#&gt;  2 2020-01-22 Washington     1      0
#&gt;  3 2020-01-23 Washington     1      0
#&gt;  4 2020-01-24 Illinois       1      0
#&gt;  5 2020-01-24 Washington     1      0
#&gt;  6 2020-01-25 California     1      0
#&gt;  7 2020-01-25 Illinois       1      0
#&gt;  8 2020-01-25 Washington     1      0
#&gt;  9 2020-01-26 Arizona        1      0
#&gt; 10 2020-01-26 California     2      0
#&gt; # … with 57,508 more rows</code></pre>
<p>Madjid’s map shows per capita rates (rates per 100,000 people) rather than absolute rates (the rates without consideration for a state’s population). So, to recreate his maps, we need to obtain data on each state’s population. Madjid downloaded this data as a CSV:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/population-by-state.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">State</span>, <span class="va">Pop</span><span class="op">)</span></span></code></pre></div>
<p>We import this data, keep the <code>State</code> and <code>Pop</code> (population) variables, and save it as an object called <code>usa_states.</code> Let’s see what <code>usa_states</code> looks like:</p>
<pre><code>#&gt; # A tibble: 52 × 2
#&gt;    State               Pop
#&gt;    &lt;chr&gt;             &lt;dbl&gt;
#&gt;  1 California     39613493
#&gt;  2 Texas          29730311
#&gt;  3 Florida        21944577
#&gt;  4 New York       19299981
#&gt;  5 Pennsylvania   12804123
#&gt;  6 Illinois       12569321
#&gt;  7 Ohio           11714618
#&gt;  8 Georgia        10830007
#&gt;  9 North Carolina 10701022
#&gt; 10 Michigan        9992427
#&gt; # … with 42 more rows</code></pre>
<p>Finally, we’ll bring in our geospatial data and save it as an object called usa_states_geom:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/albersusa/man/usa_sf.html">usa_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">us_laea_proj</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/pkg/albersusa/man/usa_sf.html">usa_sf()</a></code> function from the <code>albersausa</code> package gives us simple features data for all US states (and, conveniently, places Alaska and Hawaii in locations, and at a scale, that make them easy to see). This data includes multiple variables, but we need only the state names, so we keep the name variable only.</p>
<p>We then used the <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> function from the <code>sf</code> package to change the coordinate reference system. The one used here comes from the <code>us_laea_proj</code> object, from the <code>alberusa</code> package. Remember the A<em>lbers equal-area conic convenience projection</em> we used to change the appearance of our Wyoming counties map? This is the same projection.</p>
</div>
<div id="calculating-daily-covid-cases" class="section level3 unnumbered">
<h3>Calculating Daily COVID Cases<a class="anchor" aria-label="anchor" href="#calculating-daily-covid-cases"><i class="fas fa-link"></i></a>
</h3>
<p>Next, we need to calculate the number of daily COVID cases. We have to do this because the <code>covid_data</code> data frame gives us cumulative cases by state, but not the number of cases per day:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covid_cases</span> <span class="op">&lt;-</span> <span class="va">covid_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    pd_cases <span class="op">=</span> <span class="fu">lag</span><span class="op">(</span><span class="va">cases</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pd_cases <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    daily_cases <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">cases</span> <span class="op">&gt;</span> <span class="va">pd_cases</span> <span class="op">~</span> <span class="va">cases</span> <span class="op">-</span> <span class="va">pd_cases</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">date</span><span class="op">)</span></span></code></pre></div>
<p>We use the <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> function to calculate totals for each state, then create a new variable called <code>pd_cases</code>, which represents the number of cases in the previous day (we can use the <code>lag()</code> function to assign data to this variable). Some days do not have cases counts for the previous day, so in these cases, we set the value to 0 using the <code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> function. Finally, we create a new variable called <code>daily_cases.</code> To set the value of this variable, we use the <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> function to set up a condition: if the <code>cases</code> variable (which holds the cases on that day) is greater than the <code>pd_cases</code> variable (which holds cases from one day prior), then <code>daily_cases</code> is equal to cases minus <code>pd_cases</code>; otherwise, we set <code>daily_cases</code> to be equal to 0. Because we grouped the data by state at the beginning, we must now remove this grouping using the <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code> function before arranging our data by state and date. Now take a look at the <code>covid_cases</code> data frame we created:</p>
<pre><code>#&gt; # A tibble: 57,518 × 6
#&gt;    date       state   cases deaths pd_cases daily_cases
#&gt;    &lt;date&gt;     &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;
#&gt;  1 2020-03-13 Alabama     6      0        0           6
#&gt;  2 2020-03-14 Alabama    12      0        6           6
#&gt;  3 2020-03-15 Alabama    23      0       12          11
#&gt;  4 2020-03-16 Alabama    29      0       23           6
#&gt;  5 2020-03-17 Alabama    39      0       29          10
#&gt;  6 2020-03-18 Alabama    51      0       39          12
#&gt;  7 2020-03-19 Alabama    78      0       51          27
#&gt;  8 2020-03-20 Alabama   106      0       78          28
#&gt;  9 2020-03-21 Alabama   131      0      106          25
#&gt; 10 2020-03-22 Alabama   157      0      131          26
#&gt; # … with 57,508 more rows</code></pre>
<p>In the next step, we’ll make use of the daily_cases variable.</p>
</div>
<div id="calculating-incidence-rates" class="section level3 unnumbered">
<h3>Calculating Incidence Rates<a class="anchor" aria-label="anchor" href="#calculating-incidence-rates"><i class="fas fa-link"></i></a>
</h3>
<p>We’re not quite done calculating values. The data that Madjid used to make his map didn’t include daily case counts. Instead, it contained a five-day rolling average of cases per 100,000 people. A <em>rolling average</em> is the average case rate in a certain time period. Quirks of reporting (for example, not reporting on weekends but instead rolling Saturday and Sunday cases into Monday) can make the value for any single day less reliable. Using a rolling average smooths things out. Here is the code to generate this data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covid_cases</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>roll_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span><span class="op">(</span></span>
<span>    <span class="va">daily_cases</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    fill <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We create a new data frame called <code>covid_cases_rm</code> (where <code>rm</code> stands for rolling mean). The first step in its creation is to use the <code><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean()</a></code> function from the zoo package to create a <code>roll_cases</code> variable, which holds the average number of cases in the five-day period surrounding a single date. The <code>k</code> argument is the number of days for which we want to calculate the rolling average (five, in our case), and the <code>fill</code> argument determines what happens in cases like the first day, where we can’t calculate a five-day rolling mean because there are no days prior to this day (Madjid set these values to be NA).</p>
<p>After calculating <code>roll_cases</code>, we need to calculate per capita case rates. To do this, we needed population data, so we join the population data from the <code>usa_states</code> data frame with the <code>covid_cases</code> data:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">usa_states</span>,</span>
<span>          by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span> <span class="op">=</span> <span class="st">"State"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">Pop</span><span class="op">)</span></span></code></pre></div>
<p>We then drop rows with missing population data (the <code>Pop</code> variable). In practice, this means getting rid of several US territories (American Samoa, Guam, Northern Marianas Islands, and Virgin Islands).
Next, we created a per capita case rate variable called <code>incidence_rate</code> by multiplying the <code>roll_cases</code> variable by 100,000 and then dividing it by the population of each state:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>incidence_rate <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">5</span> <span class="op">*</span> <span class="va">roll_cases</span> <span class="op">/</span> <span class="va">Pop</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>incidence_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">incidence_rate</span>,</span>
<span>                              breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">5</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>                              include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"&gt;"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Rather than keeping raw values (for example, on June 29, 2021, Florida had a rate of 57.77737 cases per 100,000 people), we use the <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> function to convert the values into categories: values of <code>&gt;0</code> (greater than zero), <code>&gt;5</code> (greater than five), and so on, up to a maximum value of <code>&gt;50</code> (greater than 50).</p>
<p>The last step is to filter the data so it includes only 2021 data (the only year depicted in Madjid’s map) and select only the variables (<code>state</code>, <code>date</code>, and <code>incidence_rate</code>) we’ll need to create our map. Here is the final <code>covid_cases_rm</code> data frame.</p>
<pre><code>#&gt; # A tibble: 18,980 × 3
#&gt;    state   date       incidence_rate
#&gt;    &lt;chr&gt;   &lt;date&gt;     &lt;fct&gt;         
#&gt;  1 Alabama 2021-01-01 &gt;50           
#&gt;  2 Alabama 2021-01-02 &gt;50           
#&gt;  3 Alabama 2021-01-03 &gt;50           
#&gt;  4 Alabama 2021-01-04 &gt;50           
#&gt;  5 Alabama 2021-01-05 &gt;50           
#&gt;  6 Alabama 2021-01-06 &gt;50           
#&gt;  7 Alabama 2021-01-07 &gt;50           
#&gt;  8 Alabama 2021-01-08 &gt;50           
#&gt;  9 Alabama 2021-01-09 &gt;50           
#&gt; 10 Alabama 2021-01-10 &gt;50           
#&gt; # … with 18,970 more rows</code></pre>
<p>We now have a data frame that we can combine with our geospatial data.</p>
</div>
<div id="adding-geospatial-data" class="section level3 unnumbered">
<h3>Adding Geospatial Data<a class="anchor" aria-label="anchor" href="#adding-geospatial-data"><i class="fas fa-link"></i></a>
</h3>
<p>We’ve now used two of our three data sources (COVID case data and state population data) to create the <code>covid_cases_rm</code> data frame we’ll need to make the map. Let’s now use the third data source: the geospatial data we saved as <code>usa_states_geom.</code> Simple features data allows us to merge regular data frames and geospatial data, another mark in its favor:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">covid_cases_rm</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"name"</span> <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We merge our <code>covid_cases_rm</code> data frame into the geospatial data, matching the name variable from <code>usa_states_geom</code> to the state variable in <code>covid_cases_rm</code>. Next, we create a new variable called <code>fancy_date.</code> As the name implies, it’s a nicely formatted version of the date (for example, <em>Jan 01</em> instead of <em>2021-01-01</em>):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom_covid</span> <span class="op">&lt;-</span> <span class="va">usa_states_geom</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">covid_cases_rm</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"name"</span> <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fancy_date <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">"%b. %d"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">fancy_date</span>, .before <span class="op">=</span> <span class="va">incidence_rate</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/r/base/format.html">format()</a></code> function does the formatting while the <code><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder()</a></code> function makes the <code>fancy_date</code> variable sort data by date (rather than, say, alphabetically, which would put August before January). Last, we use the <code><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate()</a></code> function to put the <code>fancy_date</code> column next to the date column. We save this data frame as <code>usa_states_geom_covid</code>. Take a look at it:</p>
<pre><code>#&gt; Simple feature collection with 18615 features and 4 fields
#&gt; Geometry type: MULTIPOLYGON
#&gt; Dimension:     XY
#&gt; Bounding box:  xmin: -2100000 ymin: -2500000 xmax: 2516374 ymax: 732103.3
#&gt; CRS:           +proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs
#&gt; First 10 features:
#&gt;       name       date fancy_date incidence_rate
#&gt; 1  Arizona 2021-01-01    Jan. 01            &gt;50
#&gt; 2  Arizona 2021-01-02    Jan. 02            &gt;50
#&gt; 3  Arizona 2021-01-03    Jan. 03            &gt;50
#&gt; 4  Arizona 2021-01-04    Jan. 04            &gt;50
#&gt; 5  Arizona 2021-01-05    Jan. 05            &gt;50
#&gt; 6  Arizona 2021-01-06    Jan. 06            &gt;50
#&gt; 7  Arizona 2021-01-07    Jan. 07            &gt;50
#&gt; 8  Arizona 2021-01-08    Jan. 08            &gt;50
#&gt; 9  Arizona 2021-01-09    Jan. 09            &gt;50
#&gt; 10 Arizona 2021-01-10    Jan. 10            &gt;50
#&gt;                          geometry
#&gt; 1  MULTIPOLYGON (((-1111066 -8...
#&gt; 2  MULTIPOLYGON (((-1111066 -8...
#&gt; 3  MULTIPOLYGON (((-1111066 -8...
#&gt; 4  MULTIPOLYGON (((-1111066 -8...
#&gt; 5  MULTIPOLYGON (((-1111066 -8...
#&gt; 6  MULTIPOLYGON (((-1111066 -8...
#&gt; 7  MULTIPOLYGON (((-1111066 -8...
#&gt; 8  MULTIPOLYGON (((-1111066 -8...
#&gt; 9  MULTIPOLYGON (((-1111066 -8...
#&gt; 10 MULTIPOLYGON (((-1111066 -8...</code></pre>
<p>We can see the metadata and <code>geometry</code> columns we discussed.</p>
</div>
<div id="making-the-map" class="section level3 unnumbered">
<h3>Making the Map<a class="anchor" aria-label="anchor" href="#making-the-map"><i class="fas fa-link"></i></a>
</h3>
<p>It took a lot of work to end up with the surprisingly simple data frame <code>usa_states_geom_covid.</code> And while the data may be simple, the code Madjid used to make his map is quite complex. In this section, we walk through it in pieces.</p>
<p>The final map is actually multiple maps, one for each day in 2021. Combining 365 days makes for a large final product, so instead of showing the code for every single day, we’ll filter the <code>usa_states_geom_covid</code> to show just the first six days in January:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom_covid_six_days</span> <span class="op">&lt;-</span> <span class="va">usa_states_geom_covid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-06"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We save the result as a data frame called <code>usa_states_geom_covid_six_days</code>. Here’s what this data looks like:</p>
<pre><code>#&gt; Simple feature collection with 306 features and 4 fields
#&gt; Geometry type: MULTIPOLYGON
#&gt; Dimension:     XY
#&gt; Bounding box:  xmin: -2100000 ymin: -2500000 xmax: 2516374 ymax: 732103.3
#&gt; CRS:           +proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs
#&gt; First 10 features:
#&gt;        name       date fancy_date incidence_rate
#&gt; 1   Arizona 2021-01-01    Jan. 01            &gt;50
#&gt; 2   Arizona 2021-01-02    Jan. 02            &gt;50
#&gt; 3   Arizona 2021-01-03    Jan. 03            &gt;50
#&gt; 4   Arizona 2021-01-04    Jan. 04            &gt;50
#&gt; 5   Arizona 2021-01-05    Jan. 05            &gt;50
#&gt; 6   Arizona 2021-01-06    Jan. 06            &gt;50
#&gt; 7  Arkansas 2021-01-01    Jan. 01            &gt;50
#&gt; 8  Arkansas 2021-01-02    Jan. 02            &gt;50
#&gt; 9  Arkansas 2021-01-03    Jan. 03            &gt;50
#&gt; 10 Arkansas 2021-01-04    Jan. 04            &gt;50
#&gt;                          geometry
#&gt; 1  MULTIPOLYGON (((-1111066 -8...
#&gt; 2  MULTIPOLYGON (((-1111066 -8...
#&gt; 3  MULTIPOLYGON (((-1111066 -8...
#&gt; 4  MULTIPOLYGON (((-1111066 -8...
#&gt; 5  MULTIPOLYGON (((-1111066 -8...
#&gt; 6  MULTIPOLYGON (((-1111066 -8...
#&gt; 7  MULTIPOLYGON (((557903.1 -1...
#&gt; 8  MULTIPOLYGON (((557903.1 -1...
#&gt; 9  MULTIPOLYGON (((557903.1 -1...
#&gt; 10 MULTIPOLYGON (((557903.1 -1...</code></pre>
<p>Madjid’s map is giant, as it includes all 365 days. We’ll change the size of a few elements so they fit in this book.</p>
<div id="generating-the-basic-map" class="section level4 unnumbered">
<h4>Generating the Basic Map<a class="anchor" aria-label="anchor" href="#generating-the-basic-map"><i class="fas fa-link"></i></a>
</h4>
<p>Now that we have six days of data, let’s make some maps. Abdoul Madjid’s map-making code has three main parts: generating the basic map, changing its colors, and tweaking the theme. We’ll revisit the three lines of code used to make our Wyoming maps, with some adornments to improve the quality of the visualization:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom_covid_six_days</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">incidence_rate</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">.05</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey55"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">fancy_date</span><span class="op">)</span>,</span>
<span>    strip.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We use <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> to plot the geospatial data, modifying a couple arguments. We use <code>size = .05</code> to make the state borders less prominent and <code>color = "grey55"</code> to set the borders to a medium gray color. Then, to make one map for each day, we use the <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> function. The <code>vars(fancy_date)</code> code specifies that the <code>fancy_date</code> variable should be used to do the faceting (in other words, make one map for each day) and <code>strip.position = "bottom"</code> moves the labels <em>Jan. 01</em>, <em>Jan. 02</em>, and so on to the bottom of the maps. You can see the resulting map in Figure <a href="creating-maps.html#fig:basic-map">5.10</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:basic-map"></span>
<img src="maps_files/figure-html/basic-map-1.png" alt="A map showing the incidence rate of COVID for the first six days of 2021" width="100%"><p class="caption">
Figure 5.10: A map showing the incidence rate of COVID for the first six days of 2021
</p>
</div>
</div>
<div id="changing-colors-and-beginning-to-tweak-the-legend" class="section level4 unnumbered">
<h4>Changing Colors and Beginning to Tweak the Legend<a class="anchor" aria-label="anchor" href="#changing-colors-and-beginning-to-tweak-the-legend"><i class="fas fa-link"></i></a>
</h4>
<p>Next, we’ll tweak the colors of the maps:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom_covid_six_days</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">incidence_rate</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">.05</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey55"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">fancy_date</span><span class="op">)</span>,</span>
<span>    strip.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/scale_colour_discrete_sequential.html">scale_fill_discrete_sequential</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"Rocket"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"COVID-19 INCIDENCE RATE"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The scale_fill_discrete_sequential() function from the colorspace package sets the color scale. This function is quite similar to the scale_fill_viridis_d() function that Cédric Scherer and Georgios Karamanis used to make their drought data visualization in Chapter 2. Both visualizations use the “rocket” palette, with the fill scale going from a tan at the low end to a black at the high end. Madjid then used the name argument to set the title for the legend. By default, it would use the variable name (incidence_rate), but Madjid improves it by using “COVID-19 INCIDENCE RATE” instead. Our in-progress map can be seen in Figure <a href="creating-maps.html#fig:map-with-rocket-palette">5.11</a> below.</p>
<div class="figure">
<span style="display:block;" id="fig:map-with-rocket-palette"></span>
<img src="maps_files/figure-html/map-with-rocket-palette-1.png" alt="The COVID map with the rocket palette added" width="100%"><p class="caption">
Figure 5.11: The COVID map with the rocket palette added
</p>
</div>
<p>I’ve actually only shown a portion of the code that Abdoul Madjid used within the <code><a href="https://colorspace.R-Forge.R-project.org/reference/scale_colour_discrete_sequential.html">scale_fill_discrete_sequential()</a></code> function. He also used the guide argument and the <code><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend()</a></code> function to make tweaks to the legend. His code does the following: Puts the colored squares in one row (<code>nrow = 1</code>) rather than the default (all in a single column). Sets the height and width of each colored square (.3 centimeters for each). Sets the font family, size, and margin of both the labels (the “&gt;0,” “&gt;5,” and so on) with <code>label.theme</code> and the title (“COVID-19 INCIDENCE RATE”) with <code>title.theme</code>. Puts the title on top of the legend (<code>title.position = "top"</code>) and centers it (<code>title.hjust = .5</code>).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">usa_states_geom_covid_six_days</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">incidence_rate</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">.05</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"transparent"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">fancy_date</span><span class="op">)</span>,</span>
<span>    strip.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/scale_colour_discrete_sequential.html">scale_fill_discrete_sequential</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"Rocket"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"COVID-19 INCIDENCE RATE"</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span></span>
<span>      nrow <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      keyheight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      keywidth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      label.theme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>        family <span class="op">=</span> <span class="st">"Times New Roman"</span>,</span>
<span>        size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">rel</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span>,</span>
<span>        margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span></span>
<span>          r <span class="op">=</span> <span class="fl">5</span>,</span>
<span>          unit <span class="op">=</span> <span class="st">"pt"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      title.theme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>        family <span class="op">=</span> <span class="st">"Times New Roman"</span>,</span>
<span>        size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">rel</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>,</span>
<span>        margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span></span>
<span>          b <span class="op">=</span> <span class="fl">.1</span>,</span>
<span>          unit <span class="op">=</span> <span class="st">"cm"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      title.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>      title.hjust <span class="op">=</span> <span class="fl">.5</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>If we view our map at this point, it won’t actually look like much because the legend is currently quite large in relation to the maps. In order to change this, and to make some other tweaks to improve the look-and-feel of our maps, Madjid made multiple tweaks to the maps themselves. He did this using the <code><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme()</a></code> function from the <code>ggplot2</code> package. One benefit of making maps with ggplot is that all of the tweaks you use when making a regular plot can be carried over to your maps as well. Many of the tweaks within the <code><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme()</a></code> function below are similar to those seen in Chapter <a href="data-viz-chapter.html#data-viz-chapter">3</a>. I’m saving the map as it is now as the object map_with_legend_tweaks so that we can add onto it below.</p>
</div>
<div id="tweaking-the-theme-the-legend" class="section level4 unnumbered">
<h4>Tweaking the Theme: The Legend<a class="anchor" aria-label="anchor" href="#tweaking-the-theme-the-legend"><i class="fas fa-link"></i></a>
</h4>
<p>Let’s review the changes that Abdoul Madjid made to his maps using ggplot themes. He began by applying <code><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal()</a></code> to his map. This removes the ugly gray background that ggplot applies to plots (and maps). He then applied additional tweaks using the <code><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme()</a></code> function. Let’s start by looking at the tweaks to the legend.</p>
<p>While the code in the <code><a href="https://colorspace.R-Forge.R-project.org/reference/scale_colour_discrete_sequential.html">scale_fill_discrete_sequential()</a></code> function customized individual elements <em>within</em> the legend (for example, the size of the colored squares), the code below customizes the legend as a whole. Madjid moved the legend to the top of the maps using <code>legend.position = "top"</code> and added a bit of spacing around the legend with <code>legend.box.spacing = unit(.25, "cm")</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_with_legend_tweaks</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.box.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">.25</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can see the result of these tweaks in Figure <a href="creating-maps.html#fig:map-with-more-legend-tweaks">5.12</a> below.</p>
<div class="figure">
<span style="display:block;" id="fig:map-with-more-legend-tweaks"></span>
<img src="maps_files/figure-html/map-with-more-legend-tweaks-1.png" alt="The COVID map with additional tweaks to the legend" width="100%"><p class="caption">
Figure 5.12: The COVID map with additional tweaks to the legend
</p>
</div>
<p>As I did above, I’m saving the map as it is at this point (in this case, to an object called <code>map_with_more_legend_tweaks</code>) to avoid having to reprint all of the code for each map (I do the same thing in the sections below).</p>
</div>
<div id="tweaking-the-theme-the-title-caption-and-strip-text" class="section level4 unnumbered">
<h4>Tweaking the Theme: The Title, Caption, and Strip Text<a class="anchor" aria-label="anchor" href="#tweaking-the-theme-the-title-caption-and-strip-text"><i class="fas fa-link"></i></a>
</h4>
<p>Next, Madjid made tweaks to the title and caption. Below, we added the title and caption using this <code><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs()</a></code> function. Then, we see how Madjid used the <code><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme()</a></code> function to tweak these elements as well as the label for each map (“Jan. 01”, “Jan. 02”, and so on). He makes all text use Times New Roman and makes it a nearly black color using the hex code #111111. This sets defaults for all text elements, but Madjid also made tweaks to individual elements as well. He set the size of the title to be 2.5 times that of other text elements (<code>size = rel(2.5)</code>), made it bold (<code>face = "bold"</code>) and centered (<code>hjust = 0.5</code>), and added 0.25 centimeter margins on the top and bottom (<code>hjust = 0.5, margin = margin(t = .25, b = .25, unit = "cm")</code>). He made the same tweaks to the caption, with the exception of adjusting the font size. And finally, Abdoul Madjid adjusted the size and bolding of the individual map labels using <code>strip.text</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_with_more_legend_tweaks</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"2021 · A pandemic year"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Incidence rates are calculated for 100,000 people in each state.</span></span>
<span><span class="st">                  Inspired from a graphic in the DIE ZEIT newspaper of November 18, 2021.</span></span>
<span><span class="st">                  Data from NY Times · Tidytuesday Week-1 2022 · Abdoul ISSA BIDA."</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"Times New Roman"</span>, </span>
<span>                        color <span class="op">=</span> <span class="st">"#111111"</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">rel</a></span><span class="op">(</span><span class="fl">2.5</span><span class="op">)</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>      hjust <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>      margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                      b <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                      unit <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span></span>
<span>      hjust <span class="op">=</span> <span class="fl">.5</span>,</span>
<span>      face <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>      margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                      b <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                      unit <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">rel</a></span><span class="op">(</span><span class="fl">0.75</span><span class="op">)</span>, </span>
<span>                              face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The resulting map shows up in Figure <a href="creating-maps.html#fig:map-with-text-tweaks">5.13</a> below.</p>
<div class="figure">
<span style="display:block;" id="fig:map-with-text-tweaks"></span>
<img src="maps_files/figure-html/map-with-text-tweaks-1.png" alt="The COVID map with tweaks to the title, captions, and strip text" width="100%"><p class="caption">
Figure 5.13: The COVID map with tweaks to the title, captions, and strip text
</p>
</div>
</div>
<div id="tweaking-the-theme-grid-lines-and-axis-text" class="section level4 unnumbered">
<h4>Tweaking the Theme: Grid Lines and Axis Text<a class="anchor" aria-label="anchor" href="#tweaking-the-theme-grid-lines-and-axis-text"><i class="fas fa-link"></i></a>
</h4>
<p>Our map is looking good! Just a few tweaks left to get it close to Abdoul Madjid’s original. By default, maps made with the <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> function have axis text and lines to show longitude and latitude. Madjid removed them using the <code><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank()</a></code> function on <code>panel.grid</code> and <code>axis.text</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_with_text_tweaks</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The result, seen in Figure <a href="creating-maps.html#fig:map-with-grid-tweaks">5.14</a>, is a much nicer-looking set of maps.</p>
<div class="figure">
<span style="display:block;" id="fig:map-with-grid-tweaks"></span>
<img src="maps_files/figure-html/map-with-grid-tweaks-1.png" alt="The COVID map without the grid lines and axis text" width="100%"><p class="caption">
Figure 5.14: The COVID map without the grid lines and axis text
</p>
</div>
</div>
<div id="tweaking-the-theme-plot-background-and-margins" class="section level4 unnumbered">
<h4>Tweaking the Theme: Plot Background and Margins<a class="anchor" aria-label="anchor" href="#tweaking-the-theme-plot-background-and-margins"><i class="fas fa-link"></i></a>
</h4>
<p>The last bit of tweaking that Abdoul Madjid did was to adjust the margins around the final set of maps and give the whole thing a light gray background. The former is done within <code>plot.margin</code> while the latter is done using <code>plot.background</code>. Setting the fill color of #e5e4e2 gives it that light gray background while the <code>color = NA</code> ensures there is no outline around the plot (without that code, it would have a black border).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_with_grid_and_axis_tweaks</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                         r <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                         b <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                         l <span class="op">=</span> <span class="fl">.25</span>, </span>
<span>                         unit <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#e5e4e2"</span>, </span>
<span>                                   color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>And there we have it: Figure <a href="creating-maps.html#fig:map-with-background-tweaks">5.15</a> shows our recreation of Abdoul Madjid’s COVID-19 map.</p>
<div class="figure">
<span style="display:block;" id="fig:map-with-background-tweaks"></span>
<img src="maps_files/figure-html/map-with-background-tweaks-1.png" alt="The COVID map with tweaks to the margins and the background color" width="100%"><p class="caption">
Figure 5.15: The COVID map with tweaks to the margins and the background color
</p>
</div>
</div>
</div>
</div>
<div id="making-your-own-maps" class="section level2 unnumbered">
<h2>Making Your Own Maps<a class="anchor" aria-label="anchor" href="#making-your-own-maps"><i class="fas fa-link"></i></a>
</h2>
<p>You may now be wondering: okay, great, but how do I actually make my own maps? Let’s talk about where you can find geospatial data, how to choose a projection, and how to wrangle geospatial data to get it ready for mapping.</p>
<div id="importing-raw-data" class="section level3 unnumbered">
<h3>Importing Raw Data<a class="anchor" aria-label="anchor" href="#importing-raw-data"><i class="fas fa-link"></i></a>
</h3>
<p>There are two ways to access simple features geospatial data. The first is to import raw data. Geospatial data can take a number of different formats. While ESRI shapefiles (with the <em>.shp</em> extension) are the most common, you might also encounter GeoJSON files (<em>.geojson</em>), KML files (<em>.kml</em>), and others. Chapter 8 of <em>Geocomputation with R</em> by Robin Lovelace, Jakub Nowosad, and Jannes Muenchow discusses this range of formats.</p>
<p>The good news for us is that a single function can read pretty much any type of geospatial data: <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf()</a></code> from the <code>sf</code> package. Let’s show an example of how it works. Say you’ve downloaded geospatial data about United States state boundaries from the website <em>geojson.xyz</em> in GeoJSON format, then saved it in the <em>data</em> folder as <em>states.geojson</em>. You can then import this data using the <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf()</a></code> function:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">us_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span>dsn <span class="op">=</span> <span class="st">"data/states.geojson"</span><span class="op">)</span></span></code></pre></div>
<p>The dsn argument (which stands for data source name) tells read_sf() where to find the file. We save the data as the object <code>us_states</code>.</p>
</div>
<div id="accessing-geospatial-data-using-r-functions" class="section level3 unnumbered">
<h3>Accessing Geospatial Data Using R Functions<a class="anchor" aria-label="anchor" href="#accessing-geospatial-data-using-r-functions"><i class="fas fa-link"></i></a>
</h3>
<p>You’ll sometimes have to work with raw data in this way, but not always. That’s because certain R packages provide functions for accessing geospatial data. Madjid used the <code><a href="https://rdrr.io/pkg/albersusa/man/usa_sf.html">usa_sf()</a></code> function from the <code>albersusa</code> package to acquire his. Another package for accessing geospatial data related to the United States, <code>tigris</code>, has a number of well-named functions for different types of data. For example, we can load the <code>tigris</code> package and run the <code><a href="https://rdrr.io/pkg/tigris/man/states.html">states()</a></code> function:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris">tigris</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">states_tigris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tigris/man/states.html">states</a></span><span class="op">(</span>cb <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                        resolution <span class="op">=</span> <span class="st">"20m"</span>,</span>
<span>                        progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We use the <code>cb = TRUE</code> argument to opt us out of using the most detailed shapefile and set the resolution to a more manageable 20m. Without these changes, the shapefile we’d get would be large and slow to work with. We also set <code>progress_bar = FALSE</code> so we won’t see the messages that <code>tigris</code> shares while it loads data. We then save the result as <code>states_tigris</code>.</p>
<p>The <code>tigris</code> package has functions to get geospatial data about counties, census tracts, roads, and more. Kyle Walker, developer of the package, wrote a book, <em>Analyzing US Census Data: Methods, Maps, and Models in R</em>, if you’d like to learn more about how to use it.</p>
<p>If you’re looking for data outside of the United States, fear not! The <code>rnaturalearth</code> package provides functions for importing geospatial data from across the world. For example, <code><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">ne_countries()</a></code> can retrieve geospatial data about various countries:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth">rnaturalearth</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">africa_countries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">ne_countries</a></span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span>,</span>
<span>                                 continent <span class="op">=</span> <span class="st">"Africa"</span><span class="op">)</span></span></code></pre></div>
<p>This code uses two arguments: <code>returnclass = "sf"</code> to get data in simple features format, and <code>continent = "Africa"</code> to get only countries on the African continent. If we save the result to an object called <code>africa_countries</code>, we can plot the data on a map:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">africa_countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Figure <a href="creating-maps.html#fig:africa-map">5.16</a> shows the resulting map.</p>
<div class="figure">
<span style="display:block;" id="fig:africa-map"></span>
<img src="maps_files/figure-html/africa-map-1.png" alt="A map of Africa made with data from the rnaturalearth package" width="100%"><p class="caption">
Figure 5.16: A map of Africa made with data from the rnaturalearth package
</p>
</div>
<p>If you need geospatial data, start by looking for a package like <code>albersusa</code>, <code>tigris</code>, or <code>rnaturalearth.</code> If you can’t find one, fall back on using <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf()</a></code> from the <code>sf</code> package.</p>
</div>
<div id="using-appropriate-projections" class="section level3 unnumbered">
<h3>Using Appropriate Projections<a class="anchor" aria-label="anchor" href="#using-appropriate-projections"><i class="fas fa-link"></i></a>
</h3>
<p>Once you have access to geospatial data, you need to decide which projection to use. If you’re looking for a simple answer to this question, you’ll be disappointed. As Robin Lovelace, Jakub Nowosad, and Jannes Muenchow put it in their book <em>Geocomputation with R</em>, “the question of <em>which</em> CRS [to use] is tricky, and there is rarely a ‘right’ answer.”</p>
<p>If you feel overwhelmed by the task of choosing a projection, the <code>crsuggest</code> package, also by Kyle Walker, can give you ideas. Its <code><a href="https://rdrr.io/pkg/crsuggest/man/suggest_top_crs.html">suggest_top_crs()</a></code> function returns a coordinate reference system that is well-suited for your data. Let’s load <code>crsuggest</code> and try it out on our <code>africa_countries</code> data:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">crsuggest</span><span class="op">)</span></span>
<span></span>
<span><span class="va">africa_countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/crsuggest/man/suggest_top_crs.html">suggest_top_crs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="https://rdrr.io/pkg/crsuggest/man/suggest_top_crs.html">suggest_top_crs()</a></code> function returns the projection number 28232. We can now use this value in combination with the <code><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform()</a></code> function in order to change the projection before we plot.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">africa_countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">28232</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>When run, this code generates the map in Figure <a href="creating-maps.html#fig:africa-map-different-projection">5.17</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:africa-map-different-projection"></span>
<img src="maps_files/figure-html/africa-map-different-projection-1.png" alt="A map of Africa made with projection number 28232" width="100%"><p class="caption">
Figure 5.17: A map of Africa made with projection number 28232
</p>
</div>
<p>As you can see, we’ve mapped Africa with a different projection.</p>
</div>
<div id="bring-your-existing-r-skills-to-geospatial-data" class="section level3 unnumbered">
<h3>Bring Your Existing R Skills to Geospatial Data<a class="anchor" aria-label="anchor" href="#bring-your-existing-r-skills-to-geospatial-data"><i class="fas fa-link"></i></a>
</h3>
<p>The ability to merge traditional data frames with geospatial data is a huge benefit of working with simple features data. Remember that for his COVID map, Madjid analyzed traditional data frames before merging them with geospatial data. But because simple features data acts just like traditional data frames, we can just as easily apply the data-wrangling and analysis functions from <code>tidyverse</code> directly to a simple features object. To demonstrate this, let’s return to the <code>africa_countries</code> simple features data, selecting two variables (<code>name</code> and <code>pop_est</code>) to see the name and population of the countries:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">africa_countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">pop_est</span><span class="op">)</span></span></code></pre></div>
<p>The output looks like the following:</p>
<pre><code>#&gt; Simple feature collection with 51 features and 2 fields
#&gt; Geometry type: MULTIPOLYGON
#&gt; Dimension:     XY
#&gt; Bounding box:  xmin: -17.62504 ymin: -34.81917 xmax: 51.13387 ymax: 37.34999
#&gt; CRS:           +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0
#&gt; First 10 features:
#&gt;                    name  pop_est
#&gt; 1                Angola 12799293
#&gt; 11              Burundi  8988091
#&gt; 13                Benin  8791832
#&gt; 14         Burkina Faso 15746232
#&gt; 25             Botswana  1990876
#&gt; 26 Central African Rep.  4511488
#&gt; 31        Côte d'Ivoire 20617068
#&gt; 32             Cameroon 18879301
#&gt; 33      Dem. Rep. Congo 68692542
#&gt; 34                Congo  4012809
#&gt;                          geometry
#&gt; 1  MULTIPOLYGON (((16.32653 -5...
#&gt; 11 MULTIPOLYGON (((29.34 -4.49...
#&gt; 13 MULTIPOLYGON (((2.691702 6....
#&gt; 14 MULTIPOLYGON (((-2.827496 9...
#&gt; 25 MULTIPOLYGON (((25.64916 -1...
#&gt; 26 MULTIPOLYGON (((15.27946 7....
#&gt; 31 MULTIPOLYGON (((-2.856125 4...
#&gt; 32 MULTIPOLYGON (((13.07582 2....
#&gt; 33 MULTIPOLYGON (((30.83386 3....
#&gt; 34 MULTIPOLYGON (((12.99552 -4...</code></pre>
<p>Say we want to make a map showing which African countries have populations larger than 20 million. To do so, we’d need to first calculate this value for each country. Let’s do this using the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> functions, which will return <code>TRUE</code> if a country’s population is over 20 million and <code>FALSE</code> otherwise, then store the result in a variable called <code>population_above_20_million</code>:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">africa_countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">pop_est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>population_above_20_million <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">pop_est</span> <span class="op">&gt;</span> <span class="fl">20000000</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can then take this code and pipe it into ggplot, setting the <code>fill</code> aesthetic property to be equal to <code>population_above_20_million</code>.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">africa_countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">pop_est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>population_above_20_million <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">pop_est</span> <span class="op">&gt;</span> <span class="fl">20000000</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">population_above_20_million</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This code generates the map shown in Figure <a href="creating-maps.html#fig:africa-map-20m">5.18</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:africa-map-20m"></span>
<img src="maps_files/figure-html/africa-map-20m-1.png" alt="A map of Africa that highlights countries with populations above 20 million people" width="100%"><p class="caption">
Figure 5.18: A map of Africa that highlights countries with populations above 20 million people
</p>
</div>
<p>This is a simple example of the data wrangling and analysis you can perform on simple features data. The larger lesson is this: any skill you’ve developed for working with data in R will serve you well when working with geospatial data.</p>
</div>
<div id="in-conclusion-r-is-a-map-making-swiss-army-knife" class="section level3 unnumbered">
<h3>In Conclusion: R is a Map-Making Swiss Army Knife<a class="anchor" aria-label="anchor" href="#in-conclusion-r-is-a-map-making-swiss-army-knife"><i class="fas fa-link"></i></a>
</h3>
<p>In this short romp through the world of map-making in R, we discussed the basics of simple features geospatial data, reviewed how Abdoul Madjid applied this knowledge to make his map, discussed how to get your own geospatial data, and covered how to project it appropriately to make your own maps.</p>
<p>R may very well be the best tool for making maps. It’s way more flexible than Excel, way less expensive than ArcGIS, and uses syntax you already know. It also lets you use the skills you’ve developed for working with traditional data frames and the ggplot code that makes your visualizations look great. After all, Madjid isn’t a GIS expert, but he combined a basic understanding of geospatial data, fundamental R skills, and knowledge of data-visualization principles to make a beautiful map. Now it’s your turn to do the same.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="empty"></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Without Statistics</strong>" was written by David Keyes. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
